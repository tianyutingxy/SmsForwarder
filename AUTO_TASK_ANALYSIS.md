# 自动任务系统功能分析

## 什么是自动任务系统？

自动任务系统是一个**"当满足某些条件时，自动执行某些动作"**的自动化功能。

## 工作原理

```
触发条件满足 → 检查所有条件 → 执行配置的动作
```

例如：
- **条件**：收到来自"10086"的短信
- **动作**：播放警报、发送通知、重发消息等

---

## 支持的触发条件（11种）

### 1. **定时任务 (CRON)** - `TASK_CONDITION_CRON`
- 按 Cron 表达式定时触发（如：每天 8:00、每周一、每月1号等）
- **使用场景**：定时清理日志、定时发送报告等

### 2. **到达指定位置 (TO_ADDRESS)** - `TASK_CONDITION_TO_ADDRESS`
- 当设备到达指定地理位置时触发
- **使用场景**：到家/到公司时自动执行某些操作

### 3. **离开指定位置 (LEAVE_ADDRESS)** - `TASK_CONDITION_LEAVE_ADDRESS`
- 当设备离开指定地理位置时触发
- **使用场景**：离开家时自动执行某些操作

### 4. **网络变化 (NETWORK)** - `TASK_CONDITION_NETWORK`
- 当网络状态变化时触发（WiFi连接/断开、移动网络变化等）
- **使用场景**：连接WiFi时自动启动某些服务

### 5. **SIM卡状态 (SIM)** - `TASK_CONDITION_SIM`
- 当SIM卡插入/拔出时触发
- **使用场景**：SIM卡拔出时发送警报

### 6. **电量变化 (BATTERY)** - `TASK_CONDITION_BATTERY`
- 当电量达到指定百分比时触发
- **使用场景**：电量低于20%时发送提醒

### 7. **充电状态 (CHARGE)** - `TASK_CONDITION_CHARGE`
- 当开始充电/停止充电时触发
- **使用场景**：开始充电时发送通知

### 8. **锁屏事件 (LOCK_SCREEN)** - `TASK_CONDITION_LOCK_SCREEN`
- 当锁屏/解锁时触发
- **使用场景**：锁屏时自动清理通知、解锁时执行某些操作

### 9. **收到短信 (SMS)** - `TASK_CONDITION_SMS`
- 当收到匹配规则的短信时触发
- **使用场景**：收到验证码时自动转发并播放警报

### 10. **收到通话 (CALL)** - `TASK_CONDITION_CALL`
- 当收到匹配规则的通话时触发
- **使用场景**：收到重要来电时播放警报

### 11. **收到应用通知 (APP)** - `TASK_CONDITION_APP` ⭐ **这个对你有用**
- 当收到匹配规则的应用通知时触发
- **使用场景**：
  - 收到重要通知时播放警报（振动+闪光+音乐）
  - 收到特定应用通知时自动重发
  - 收到通知时自动清理旧日志

### 12. **蓝牙状态 (BLUETOOTH)** - `TASK_CONDITION_BLUETOOTH`
- 当蓝牙设备连接/断开时触发
- **使用场景**：蓝牙耳机连接时自动调整设置

---

## 支持的执行动作（11种）

### 1. **发送短信 (SENDSMS)** - `TASK_ACTION_SENDSMS`
- 发送短信到指定号码
- **使用场景**：收到重要通知时自动发送短信提醒

### 2. **发送通知 (NOTIFICATION)** - `TASK_ACTION_NOTIFICATION` ⭐ **这个对你有用**
- 通过配置的规则转发消息（会使用规则中的发送通道）
- **使用场景**：收到特定通知时，通过邮件再次转发

### 3. **清理操作 (CLEANER)** - `TASK_ACTION_CLEANER` ⭐ **这个对你有用**
- 清理指定天数前的消息记录和日志
- **使用场景**：定期自动清理旧数据，节省存储空间

### 4. **修改设置 (SETTINGS)** - `TASK_ACTION_SETTINGS`
- 修改应用的各种设置（开关通知转发、修改定位设置等）
- **使用场景**：根据时间或位置自动调整应用设置

### 5. **Frpc操作 (FRPC)** - `TASK_ACTION_FRPC`
- 启动/停止 Frpc 内网穿透
- **使用场景**：连接WiFi时自动启动Frpc

### 6. **HTTP服务器操作 (HTTPSERVER)** - `TASK_ACTION_HTTPSERVER`
- 启动/停止 HTTP 服务器
- **使用场景**：到达指定位置时启动服务器

### 7. **规则操作 (RULE)** - `TASK_ACTION_RULE` ⭐ **这个对你有用**
- 启用/禁用指定的转发规则
- **使用场景**：根据时间自动开启/关闭某些转发规则

### 8. **发送通道操作 (SENDER)** - `TASK_ACTION_SENDER` ⭐ **这个对你有用**
- 启用/禁用指定的发送通道
- **使用场景**：根据时间自动开启/关闭某些发送通道

### 9. **警报 (ALARM)** - `TASK_ACTION_ALARM` ⭐ **这个对你有用**
- 播放警报（振动+闪光灯+音乐）
- **使用场景**：收到重要通知时播放警报提醒

### 10. **重发消息 (RESEND)** - `TASK_ACTION_RESEND` ⭐ **这个对你有用**
- 重发指定时间内失败的消息
- **使用场景**：网络恢复后自动重发失败的消息

### 11. **任务操作 (TASK)** - `TASK_ACTION_TASK`
- 启用/禁用其他自动任务
- **使用场景**：任务之间的级联控制

---

## 实际使用场景示例

### 场景1：收到重要通知时播放警报
- **触发条件**：收到来自"微信"的应用通知，且内容包含"紧急"
- **执行动作**：播放警报（振动+闪光+音乐）
- **用途**：确保重要通知不会被错过

### 场景2：定期自动清理日志
- **触发条件**：每天凌晨2点（Cron定时任务）
- **执行动作**：清理30天前的消息和日志
- **用途**：节省存储空间

### 场景3：收到验证码时自动转发并播放警报
- **触发条件**：收到包含"验证码"的应用通知
- **执行动作**：
  1. 通过邮件转发（Notification动作）
  2. 播放警报（Alarm动作）
- **用途**：重要验证码及时提醒

### 场景4：网络恢复后自动重发失败的消息
- **触发条件**：网络从断开变为连接（Network条件）
- **执行动作**：重发最近1小时内失败的消息（Resend动作）
- **用途**：确保消息不丢失

### 场景5：根据时间自动开启/关闭转发规则
- **触发条件**：每天22:00（Cron定时任务）
- **执行动作**：禁用所有转发规则（Rule动作）
- **用途**：免打扰时间自动关闭转发

---

## 对你的需求的价值评估

### ✅ 可能有用的功能

1. **收到应用通知时播放警报** (`TASK_CONDITION_APP` + `TASK_ACTION_ALARM`)
   - 当收到重要通知时，播放警报提醒
   - **价值**：⭐⭐⭐ 中等（如果只需要转发，可能不需要）

2. **定期自动清理日志** (`TASK_CONDITION_CRON` + `TASK_ACTION_CLEANER`)
   - 定期清理旧的消息和日志
   - **价值**：⭐⭐ 较低（可以手动清理）

3. **重发失败的消息** (`TASK_ACTION_RESEND`)
   - 网络恢复后自动重发失败的消息
   - **价值**：⭐⭐⭐ 中等（如果邮件发送失败，可以自动重试）

4. **根据时间自动开启/关闭规则** (`TASK_CONDITION_CRON` + `TASK_ACTION_RULE`)
   - 免打扰时间自动关闭转发
   - **价值**：⭐⭐ 较低（规则本身已经有免打扰时间段功能）

### ❌ 不需要的功能

1. **短信相关** (`TASK_CONDITION_SMS`, `TASK_ACTION_SENDSMS`) - 你不需要短信功能
2. **通话相关** (`TASK_CONDITION_CALL`) - 你不需要通话功能
3. **定位相关** (`TASK_CONDITION_TO_ADDRESS`, `TASK_CONDITION_LEAVE_ADDRESS`) - 你不需要定位功能
4. **蓝牙相关** (`TASK_CONDITION_BLUETOOTH`) - 你不需要蓝牙功能
5. **电量/充电相关** (`TASK_CONDITION_BATTERY`, `TASK_CONDITION_CHARGE`) - 你不需要电量监控
6. **SIM卡相关** (`TASK_CONDITION_SIM`) - 你不需要SIM卡监控
7. **网络变化** (`TASK_CONDITION_NETWORK`) - 可能不需要
8. **Frpc/HttpServer相关** (`TASK_ACTION_FRPC`, `TASK_ACTION_HTTPSERVER`) - 你不需要这些功能
9. **锁屏相关** (`TASK_CONDITION_LOCK_SCREEN`) - 主要用于自动任务，不是通知转发过滤

---

## 建议

### 方案A：完全删除自动任务系统（推荐）

**理由**：
1. 你的核心需求是"应用通知 → 邮件转发"，自动任务系统是额外的自动化功能
2. 自动任务系统涉及大量代码（Task实体、ActionWorker、各种Condition/Action Fragment等）
3. 大部分触发条件和动作你都不需要
4. 即使保留，你也只会用到很少的功能（警报、清理、重发）

**删除内容**：
- `database/entity/Task.kt`
- `workers/ActionWorker.kt`
- `workers/LockScreenWorker.kt`
- `fragment/TasksFragment.kt`
- `fragment/condition/` 目录下所有文件
- `fragment/action/` 目录下所有文件
- `utils/task/` 目录下所有文件
- `SendWorker.kt` 中的 `autoTaskProcess()` 方法

### 方案B：保留但精简自动任务系统

**如果**你确实需要以下功能：
- 收到重要通知时播放警报
- 定期自动清理日志
- 自动重发失败的消息

**可以保留**：
- `TASK_CONDITION_APP` - 应用通知触发
- `TASK_CONDITION_CRON` - 定时任务触发
- `TASK_ACTION_ALARM` - 警报
- `TASK_ACTION_CLEANER` - 清理
- `TASK_ACTION_RESEND` - 重发
- `TASK_ACTION_NOTIFICATION` - 转发通知（可能有用）

**删除**：
- 其他所有不需要的触发条件和动作

---

## 我的建议

**建议采用方案A（完全删除）**，原因：

1. **简化代码**：自动任务系统代码量很大，删除后代码更简洁
2. **核心功能不受影响**：通知转发功能完全独立，不依赖自动任务
3. **功能重叠**：
   - 警报功能：可以通过规则配置实现（虽然可能不如自动任务灵活）
   - 清理功能：可以手动清理，或者后续需要时再加
   - 重发功能：可以手动重发，或者后续需要时再加
4. **减少维护成本**：代码越少，维护越容易

**如果**你确实需要"收到重要通知时播放警报"这个功能，可以考虑：
- 在 `NotificationService` 中直接添加简单的警报逻辑
- 或者保留最小化的自动任务系统（只保留 APP 条件 + ALARM 动作）

---

## 你的决定？

请告诉我：
1. 你是否需要"收到重要通知时播放警报"功能？
2. 你是否需要"定期自动清理日志"功能？
3. 你是否需要"自动重发失败消息"功能？

根据你的回答，我可以给出更精确的建议。
